---
alwaysApply: true
---

# Delivery Platform - Guia de Desenvolvimento

## ğŸ¯ VisÃ£o Geral

Plataforma SaaS de delivery multi-tenant onde cada restaurante possui seu prÃ³prio banco de dados isolado. Backend Laravel com padrÃµes arquiteturais robustos + Frontend Nuxt 3.

## ğŸ“ Arquitetura Multi-Tenant

### EstratÃ©gia: DB por Restaurante

**Central DB:** `delivery_central`
- Tabelas: `restaurants`, `plans`, `subscriptions`, `subscription_invoices`
- Campo `restaurants.db_name` define qual DB do tenant (ex: `tenant_42`)

**Tenant DBs:** `tenant_{restaurant_id}`
- Tabelas: `products`, `menus`, `menu_items`, `customers`, `orders`, `order_items`, `order_invoices`, `settings`

### Dynamic Database Connection

```php
// Middleware IdentifyTenantMiddleware
$tenant = Restaurant::where('slug', $slug)->first();
config(['database.connections.tenant.database' => $tenant->db_name]);
DB::purge('tenant');
DB::reconnect('tenant');
```

### Provisionar Novo Tenant

```php
$restaurant = Restaurant::create([...]);
$dbName = "tenant_{$restaurant->id}";

DB::statement("CREATE DATABASE `{$dbName}` CHARACTER SET utf8mb4");

config(['database.connections.tenant.database' => $dbName]);
DB::purge('tenant');
DB::reconnect('tenant');
Artisan::call('migrate', ['--database' => 'tenant', '--path' => 'database/migrations/tenant']);
```

## ğŸ› ï¸ Stack TecnolÃ³gica

**Backend:** Laravel 12 (PHP 8.3) â€¢ MySQL 8.0 â€¢ Redis 7.0 â€¢ Sanctum â€¢ Horizon  
**Frontend:** Nuxt 3.14 â€¢ Vue 3.5 â€¢ TypeScript 5.5 â€¢ Tailwind 3.4 â€¢ Pinia 2.1  
**DevOps:** Docker â€¢ Docker Compose â€¢ Nginx â€¢ Traefik

## ğŸŒ URLs & IdentificaÃ§Ã£o

- **Frontend:** http://delivery.meudominio.dev.br
- **API Central:** http://delivery.meudominio.dev.br/api/central
- **API Tenant:** http://{slug}-delivery.meudominio.dev.br/api

### PadrÃ£o de SubdomÃ­nio para Tenants

O middleware `IdentifyTenantMiddleware` identifica o tenant pelo padrÃ£o `{slug}-delivery`:

| URL | Slug ExtraÃ­do |
|-----|---------------|
| `demo-delivery.meudominio.dev.br` | `demo` |
| `pizzaria-delivery.meudominio.dev.br` | `pizzaria` |
| `custom.com` (domÃ­nio prÃ³prio) | busca por `domain` |

**Vantagem:** Wildcard SSL gratuito do Cloudflare funciona com subdomÃ­nios de primeiro nÃ­vel (`*.meudominio.dev.br`).

## ğŸ“¦ PadrÃµes Arquiteturais

### 1. DTOs (Data Transfer Objects)

BaseDTO com validaÃ§Ã£o automÃ¡tica, casts customizados e serializaÃ§Ã£o.

**Tipos de DTOs:**
- **QueryDTO:** Campos `nullable` para consultas
- **CreateDTO:** Campos `required` para criaÃ§Ã£o
- **UpdateDTO:** Campos `sometimes|required` para atualizaÃ§Ã£o
- **OperationDTO:** Campos especÃ­ficos para operaÃ§Ãµes pontuais

```php
class ProductCreateDTO extends BaseDTO
{
    public static function getFillableAttributes(): Collection
    {
        // Importante: Somente faÃ§a merge dos atributos padrÃ£o (id, created_at, updated_at)
        // se a tabela da entidade realmente possuir esses campos.
        return parent::getFillableAttributes()->merge([
            'name' => 'required|string|max:255',
            'price' => 'required|numeric|min:0',
            'description' => 'nullable|string',
            'active' => 'nullable|boolean',
        ]);
    }
}
```

### 2. Services Layer Pattern

SeparaÃ§Ã£o por responsabilidade:
- **CreatorService:** CriaÃ§Ã£o de entidades
- **UpdaterService:** AtualizaÃ§Ã£o de entidades
- **DeleterService:** ExclusÃ£o de entidades
- **FinderService:** Busca e consulta de entidades

```php
class ProductCreatorService extends SaverService
{
    public function create(ProductCreateDTO $dto): ProductDTO
    {
        return $this->save($dto);
    }

    protected function saveEntity(array $attributes): BaseDTO
    {
        $product = Product::create($attributes);
        return new ProductDTO($product->toArray());
    }

    // Hooks: beforeSave(), afterSave(), mapDataToSave()
}
```

### 3. Controllers Pattern

Controllers **enxutos** - apenas coordenam:
1. Recebe requisiÃ§Ã£o
2. Cria DTO
3. Chama service
4. Retorna resposta padronizada

```php
public function store(Request $request, ProductCreatorService $creatorService): JsonResponse
{
    $dto = new ProductCreateDTO($request->all());
    $product = $creatorService->create($dto);
    return response()->json($product->toArray(), 201);
}
```

**PadrÃ£o de Resposta JSON:**
```json
{
    "data": [...],
    "pagination": {"page": 1, "limit": 20, "total": 100, "totalPages": 5}
}
```

### 4. Models

Apenas lÃ³gica de persistÃªncia e Eloquent:
- `$fillable` para mass assignment
- `$hidden` para dados sensÃ­veis
- `casts()` para conversÃµes
- MÃ©todos auxiliares simples

**Importante:**
- **NUNCA** faÃ§a chamadas diretas de Models (Eloquent) fora dos seus respectivos Services.
- As chamadas devem ser centralizadas nos Services (Finder, Creator, Updater, Deleter) para garantir que, se houver necessidade de mudar uma chamada do Eloquent para outro serviÃ§o externo, a manutenÃ§Ã£o seja fÃ¡cil e isolada.

### 5. Type Casting System

```php
// Interface BaseCast
interface BaseCast {
    public static function set(mixed $value): mixed;
    public static function get(mixed $value): mixed;
}

// Usar no DTO
protected array $casts = ['date' => DateCast::class];
```

## ğŸ”— Fluxo de RequisiÃ§Ã£o

```
Request â†’ Controller â†’ DTO â†’ Service â†’ Model â†’ Database
   â†“          â†“          â†“       â†“        â†“        â†“
POST      Controller   CreateDTO CreatorSvc Model  INSERT
```

## âœ… Checklist para Novos Recursos

Ao adicionar entidade (ex: `Product`):

1. **DTOs:** ProductDTO, ProductCreateDTO, ProductUpdateDTO
2. **Services:** ProductCreatorService, ProductUpdaterService, ProductDeleterService, ProductFinderService
3. **Controller:** ProductController com mÃ©todos CRUD
4. **Model:** Product com `$fillable`, `$hidden`, `casts()`
5. **Rotas:** Adicionar em `routes/api.php` com middlewares
6. **Migrations:** Criar tabela com Ã­ndices e constraints

## ğŸ“‚ Estrutura de DiretÃ³rios

```
app/
â”œâ”€â”€ Contracts/DTOs/BaseCast.php
â”œâ”€â”€ DTOs/
â”‚   â”œâ”€â”€ BaseDTO.php
â”‚   â”œâ”€â”€ Casts/DateCast.php
â”‚   â””â”€â”€ {Entity}DTO.php (Query, Create, Update)
â”œâ”€â”€ Http/Controllers/Api/{Entity}Controller.php
â”œâ”€â”€ Models/{Entity}.php
â””â”€â”€ Services/
    â”œâ”€â”€ SaverService/SaverService.php
    â””â”€â”€ {Entity}{Action}Service.php
```

## ğŸ¯ PrincÃ­pios SOLID

- **SRP:** Um service = uma responsabilidade
- **OCP:** BaseDTO e SaverService extensÃ­veis via hooks
- **LSP:** Subclasses substituem classes base
- **ISP:** Interfaces pequenas e especÃ­ficas
- **DIP:** InjeÃ§Ã£o de dependÃªncia, nÃ£o instanciaÃ§Ã£o direta

## ğŸš€ Comandos Ãšteis

**Backend:**
```bash
make up setup shell
make artisan cmd="migrate --path=database/migrations/central"
make artisan cmd="migrate --database=tenant --path=database/migrations/tenant"
```

**Frontend:**
```bash
make up install shell logs
```

## âš ï¸ Notas Importantes

1. **Sempre use `tenant` connection** para dados do restaurante
2. **Central connection** apenas para metadados (restaurants, plans)
3. **Cada tenant Ã© isolado** - sem cross-tenant queries
4. **Jobs devem saber qual tenant** (passar tenant_id ou db_name)
5. **Middleware IdentifyTenantMiddleware** obrigatÃ³rio em todas rotas tenant

## ğŸ“‹ ConvenÃ§Ãµes

**Nomenclatura:**
- DTOs: `UserCreateDTO`, `UserUpdateDTO`
- Services: `UserCreatorService`, `UserFinderService`
- Controllers: `UserController` (organize por contexto: `Api/`, `Admin/`)
- Models: `User`, `Product` (singular, PascalCase)
- MÃ©todos Services: `create()`, `update()`, `delete()`, `findById()`, `findAll()`
- MÃ©todos Controllers: `index()`, `store()`, `show()`, `update()`, `destroy()`

**Respostas HTTP:**
- Lista: 200 OK + paginaÃ§Ã£o
- CriaÃ§Ã£o: 201 Created
- AtualizaÃ§Ã£o: 200 OK
- DeleÃ§Ã£o: 204 No Content

## ğŸ¯ Vantagens da Arquitetura

âœ… **Manutenibilidade:** CÃ³digo organizado, mudanÃ§as isoladas  
âœ… **Testabilidade:** Services testÃ¡veis isoladamente, injeÃ§Ã£o de dependÃªncia  
âœ… **Escalabilidade:** FÃ¡cil adicionar recursos seguindo padrÃµes  
âœ… **Type Safety:** DTOs garantem tipos e validaÃ§Ã£o automÃ¡tica  
âœ… **SeparaÃ§Ã£o de Responsabilidades:** Cada camada com funÃ§Ã£o bem definida